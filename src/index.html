<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Sysproxy Demo - ä»£ç†æœåŠ¡å™¨</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
        color-scheme: light dark;
        --primary: #2563eb;
        --success: #16a34a;
        --danger: #dc2626;
        --warning: #f59e0b;
        --border: #e5e7eb;
        --bg-secondary: #f9fafb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      h1,
      h2,
      h3 {
        margin: 0 0 12px 0;
        font-weight: 600;
      }

      h1 {
        font-size: 24px;
      }
      h2 {
        font-size: 18px;
      }
      h3 {
        font-size: 16px;
      }

      .tabs {
        display: flex;
        gap: 8px;
        border-bottom: 2px solid var(--border);
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
      }

      .tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .card {
        padding: 20px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
      }

      .form-group {
        margin-bottom: 16px;
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 14px;
      }

      input[type='text'],
      input[type='number'],
      textarea,
      select {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid var(--border);
        font-family: inherit;
      }

      input[type='checkbox'] {
        width: auto;
        margin: 0;
        cursor: pointer;
      }

      textarea {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
        resize: vertical;
      }

      .btn {
        padding: 10px 16px;
        font-size: 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: opacity 0.2s;
      }

      .btn:hover:not(:disabled) {
        opacity: 0.9;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
      }
      .btn-secondary {
        background: #6b7280;
        color: white;
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
      }

      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-running {
        background: #dcfce7;
        color: var(--success);
      }
      .status-stopped {
        background: #fee2e2;
        color: var(--danger);
      }

      .log-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 10px;
        background: #f9fafb;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        font-size: 12px;
      }

      .log-entry {
        padding: 8px;
        margin-bottom: 4px;
        border-left: 3px solid var(--border);
        background: white;
      }

      .log-entry.success {
        border-left-color: var(--success);
      }
      .log-entry.error {
        border-left-color: var(--danger);
      }

      .rule-item {
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 10px;
        background: white;
      }

      .rule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .rule-name {
        font-weight: 600;
        font-size: 14px;
      }

      .rule-details {
        font-size: 12px;
        color: #6b7280;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: '';
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--success);
      }

      input:checked + .slider:before {
        transform: translateX(20px);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      .cert-info {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 13px;
        margin-top: 10px;
      }

      .message {
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 16px;
        font-size: 14px;
        white-space: pre-line; /* Preserve line breaks */
        line-height: 1.6;
      }

      .message.success {
        background: #dcfce7;
        color: var(--success);
      }
      .message.error {
        background: #fee2e2;
        color: var(--danger);
      }
      .message.info {
        background: #dbeafe;
        color: #2563eb;
      }

      /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 24px;
        border-radius: 8px;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .modal-header {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--danger);
      }

      .modal-body {
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
    </style>
  </head>
  <body>
    <h1>ğŸš€ Sysproxy ä»£ç†æœåŠ¡å™¨</h1>

    <div class="tabs">
      <button class="tab active" data-tab="server">ä»£ç†æœåŠ¡å™¨</button>
      <button class="tab" data-tab="system">ç³»ç»Ÿä»£ç†</button>
      <button class="tab" data-tab="tun">TUN ä»£ç†</button>
      <button class="tab" data-tab="process">è¿›ç¨‹è¿‡æ»¤</button>
      <button class="tab" data-tab="certificate">è¯ä¹¦ç®¡ç†</button>
      <button class="tab" data-tab="rules">æ‹¦æˆªè§„åˆ™</button>
      <button class="tab" data-tab="logs">æ—¥å¿—æŸ¥çœ‹</button>
    </div>

    <!-- ä»£ç†æœåŠ¡å™¨ -->
    <div class="tab-content active" id="tab-server">
      <div class="card">
        <h2>ä»£ç†æœåŠ¡å™¨æ§åˆ¶</h2>
        <div
          id="server-status"
          class="message info"
          style="display: none"
        ></div>

        <div class="form-group">
          <label>
            æœåŠ¡å™¨çŠ¶æ€
            <span id="status-badge" class="status-indicator status-stopped"
              >â— æœªè¿è¡Œ</span
            >
          </label>
        </div>

        <div class="form-group">
          <label for="proxy-port">ç›‘å¬ç«¯å£</label>
          <input
            type="number"
            id="proxy-port"
            value="8888"
            min="1024"
            max="65535"
          />
        </div>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 10px">
            <input type="checkbox" id="enable-https" checked />
            å¯ç”¨ HTTPS æ‹¦æˆªï¼ˆMITMï¼‰
          </label>
        </div>

        <div class="btn-group">
          <button class="btn btn-success" id="start-server">
            å¯åŠ¨ä»£ç†æœåŠ¡å™¨
          </button>
          <button class="btn btn-danger" id="stop-server" disabled>
            åœæ­¢ä»£ç†æœåŠ¡å™¨
          </button>
        </div>
      </div>
    </div>

    <!-- ç³»ç»Ÿä»£ç† -->
    <div class="tab-content" id="tab-system">
      <div class="card">
        <h2>ç³»ç»Ÿä»£ç†è®¾ç½®</h2>
        <div id="system-status" class="message" style="display: none"></div>

        <div class="form-group">
          <label for="host">ä»£ç† IP</label>
          <input id="host" placeholder="ä¾‹å¦‚ 127.0.0.1" value="127.0.0.1" />
        </div>

        <div class="form-group">
          <label for="port">ä»£ç†ç«¯å£</label>
          <input id="port" type="number" placeholder="ä¾‹å¦‚ 8888" value="8888" />
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" id="apply">åº”ç”¨ä»£ç†</button>
          <button class="btn btn-secondary" id="restore">æ¢å¤åŸä»£ç†</button>
        </div>

        <div class="form-group" style="margin-top: 20px">
          <label>åŸä»£ç†é…ç½®ï¼ˆJSONï¼Œé¦–æ¬¡ä¿å­˜åæ˜¾ç¤ºï¼‰</label>
          <textarea id="saved" rows="8" readonly></textarea>
        </div>

        <div class="form-group">
          <label>
            å½“å‰ç³»ç»Ÿä»£ç†ï¼ˆJSONï¼‰
            <button
              class="btn btn-sm btn-secondary"
              id="current"
              style="margin-left: 10px"
            >
              åˆ·æ–°
            </button>
          </label>
          <textarea id="current-text" rows="8" readonly></textarea>
        </div>
      </div>
    </div>

    <!-- TUN ä»£ç† -->
    <div class="tab-content" id="tab-tun">
      <div class="card">
        <h2>TUN é€æ˜ä»£ç†</h2>
        <div id="tun-status" class="message" style="display: none"></div>

        <div class="message info">
          <strong>ğŸ’¡ ä»€ä¹ˆæ˜¯ TUN æ¨¡å¼ï¼Ÿ</strong><br>
          TUN æ¨¡å¼åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸çº§åˆ«æ‹¦æˆªç½‘ç»œæµé‡ï¼Œæ— éœ€é…ç½®ç³»ç»Ÿä»£ç†ã€‚<br>
          é€‚ç”¨äºä¸æ”¯æŒä»£ç†é…ç½®çš„åº”ç”¨ç¨‹åºã€‚<br><br>
          <strong>âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</strong><br>
          â€¢ TUN æ¨¡å¼éœ€è¦<strong>ç®¡ç†å‘˜æƒé™</strong>ï¼ˆmacOS å¯åŠ¨æ—¶ä¼šå¼¹å‡ºå¯†ç å¯¹è¯æ¡†ï¼‰<br>
          â€¢ TUN ä¸ç³»ç»Ÿä»£ç†å¯ä»¥åŒæ—¶è¿è¡Œï¼ˆTUN ä¼˜å…ˆçº§æ›´é«˜ï¼‰<br>
          â€¢ æµé‡ä¼šå…ˆç»è¿‡ TUNï¼Œç„¶åè½¬å‘åˆ°æœ¬åœ° HTTP ä»£ç†ï¼ˆç«¯å£ 8888ï¼‰<br>
          â€¢ è¿›ç¨‹è¿‡æ»¤è§„åˆ™åŒæ—¶åº”ç”¨äº TUN å’Œç³»ç»Ÿä»£ç†æ¨¡å¼
        </div>

        <div class="form-group">
          <label>
            TUN çŠ¶æ€
            <span id="tun-status-badge" class="status-indicator status-stopped">â— æœªè¿è¡Œ</span>
          </label>
        </div>

        <div id="tun-info" class="cert-info" style="display: none;">
          <div><strong>mihomo ç‰ˆæœ¬:</strong> <span id="tun-version">-</span></div>
          <div><strong>TUN è®¾å¤‡:</strong> <span id="tun-device">-</span></div>
        </div>

        <div class="btn-group">
          <button class="btn btn-success" id="start-tun">
            å¯åŠ¨ TUN ä»£ç†
          </button>
          <button class="btn btn-danger" id="stop-tun" disabled>
            åœæ­¢ TUN ä»£ç†
          </button>
        </div>

        <div class="message info" style="margin-top: 20px;">
          <strong>ğŸ“Š å·¥ä½œåŸç†</strong><br>
          åº”ç”¨ç¨‹åº â†’ TUN æ¥å£ (mihomo) â†’ HTTP ä»£ç†æœåŠ¡å™¨ (127.0.0.1:8888) â†’ ç›®æ ‡æœåŠ¡å™¨<br><br>
          æ‰€æœ‰æ‹¦æˆªè§„åˆ™ã€HTTPS MITM å’Œè¿›ç¨‹è¿‡æ»¤åŠŸèƒ½éƒ½åœ¨ HTTP ä»£ç†å±‚ç”Ÿæ•ˆã€‚
        </div>
      </div>
    </div>

    <!-- è¿›ç¨‹è¿‡æ»¤ -->
    <div class="tab-content" id="tab-process">
      <div class="card">
        <h2>è¿›ç¨‹è¿‡æ»¤è®¾ç½®</h2>
        <div id="process-status" class="message" style="display: none"></div>

        <p style="color: #6b7280; margin-bottom: 16px;">
          è®¾ç½®åªæ•è·ç‰¹å®šè¿›ç¨‹çš„æµé‡ï¼Œç±»ä¼¼ Reqable çš„è¿›ç¨‹è¿‡æ»¤åŠŸèƒ½ã€‚
        </p>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 10px">
            <input type="checkbox" id="enable-process-filter" />
            å¯ç”¨è¿›ç¨‹è¿‡æ»¤
          </label>
        </div>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 10px">
            <input type="checkbox" id="blacklist-mode" />
            é»‘åå•æ¨¡å¼ï¼ˆå‹¾é€‰=é»‘åå•ï¼Œä¸å‹¾é€‰=ç™½åå•ï¼‰
          </label>
          <small style="color: #6b7280; display: block; margin-top: 4px;">
            ç™½åå•ï¼šåªæ˜¾ç¤ºé€‰ä¸­è¿›ç¨‹çš„æµé‡<br>
            é»‘åå•ï¼šæ˜¾ç¤ºé™¤é€‰ä¸­è¿›ç¨‹å¤–çš„æ‰€æœ‰æµé‡
          </small>
        </div>

        <div style="margin-bottom: 16px;">
          <button class="btn btn-sm btn-primary" id="refresh-processes">
            ğŸ”„ åˆ·æ–°è¿›ç¨‹åˆ—è¡¨
          </button>
          <button class="btn btn-sm btn-secondary" id="clear-process-filter">
            æ¸…ç©ºé€‰æ‹©
          </button>
        </div>

        <div class="form-group">
          <label>
            ç³»ç»Ÿè¿›ç¨‹åˆ—è¡¨ï¼ˆæœç´¢æˆ–æ»šåŠ¨é€‰æ‹©ï¼‰
            <input
              type="text"
              id="process-search"
              placeholder="æœç´¢è¿›ç¨‹åç§°..."
              style="margin-top: 8px;"
            />
          </label>
        </div>

        <div class="log-container" id="process-list-container" style="max-height: 400px;">
          <div style="color: #6b7280;">åŠ è½½è¿›ç¨‹åˆ—è¡¨...</div>
        </div>

        <div style="margin-top: 16px;">
          <strong>å·²é€‰æ‹©çš„è¿›ç¨‹ï¼š</strong>
          <div id="selected-processes" style="margin-top: 8px;">
            <span style="color: #6b7280;">æš‚æ— é€‰æ‹©</span>
          </div>
        </div>
      </div>
    </div>

    <!-- è¯ä¹¦ç®¡ç† -->
    <div class="tab-content" id="tab-certificate">
      <div class="card">
        <h2>HTTPS è¯ä¹¦ç®¡ç†</h2>
        <div id="cert-status" class="message" style="display: none"></div>

        <p>ä¸ºäº†æ‹¦æˆª HTTPS æµé‡ï¼Œéœ€è¦å®‰è£…è‡ªç­¾åçš„ CA è¯ä¹¦åˆ°ç³»ç»Ÿä¿¡ä»»å­˜å‚¨ã€‚</p>

        <div class="cert-info">
          <div>
            <strong>è¯ä¹¦çŠ¶æ€:</strong>
            <span id="cert-installed">æ£€æŸ¥ä¸­...</span>
          </div>
          <div>
            <strong>è¯ä¹¦è·¯å¾„:</strong> <span id="cert-path">åŠ è½½ä¸­...</span>
          </div>
        </div>

        <div class="btn-group" style="margin-top: 16px">
          <button class="btn btn-primary" id="install-cert">å®‰è£…è¯ä¹¦</button>
          <button class="btn btn-danger" id="uninstall-cert">åˆ é™¤è¯ä¹¦</button>
          <button class="btn btn-secondary" id="check-cert">
            æ£€æŸ¥è¯ä¹¦çŠ¶æ€
          </button>
          <button class="btn btn-secondary" id="open-cert-folder">
            æ‰“å¼€è¯ä¹¦æ–‡ä»¶å¤¹
          </button>
        </div>
      </div>
    </div>

    <!-- æ‹¦æˆªè§„åˆ™ -->
    <div class="tab-content" id="tab-rules">
      <div class="card">
        <h2>HTTP/HTTPS æ‹¦æˆªè§„åˆ™</h2>
        <div id="rules-status" class="message" style="display: none"></div>

        <button
          class="btn btn-primary"
          id="add-rule-btn"
          style="margin-bottom: 16px"
        >
          + æ·»åŠ æ–°è§„åˆ™
        </button>

        <div id="rules-container">
          <p style="color: #6b7280">æš‚æ— è§„åˆ™ã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ è§„åˆ™ã€‚</p>
        </div>
      </div>
    </div>

    <!-- æ—¥å¿—æŸ¥çœ‹ -->
    <div class="tab-content" id="tab-logs">
      <div class="card">
        <h2>
          ä»£ç†æ—¥å¿—
          <button
            class="btn btn-sm btn-secondary"
            id="clear-logs"
            style="margin-left: 10px"
          >
            æ¸…ç©ºæ—¥å¿—
          </button>
        </h2>

        <div class="log-container" id="log-container">
          <div style="color: #6b7280">ç­‰å¾…æ—¥å¿—...</div>
        </div>
      </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="confirm-modal">
      <div class="modal-content">
        <div class="modal-header">âš ï¸ ç¡®è®¤åˆ é™¤è¯ä¹¦</div>
        <div class="modal-body">
          æ‚¨ç¡®å®šè¦åˆ é™¤ Sysproxy MITM CA è¯ä¹¦å—ï¼Ÿ<br /><br />
          åˆ é™¤åå°†æ— æ³•æ‹¦æˆª HTTPS æµé‡ã€‚
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="modal-cancel">å–æ¶ˆ</button>
          <button class="btn btn-danger" id="modal-confirm">ç¡®å®šåˆ é™¤</button>
        </div>
      </div>
    </div>

    <!-- è§„åˆ™ç¼–è¾‘å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="rule-modal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header" id="rule-modal-title">æ·»åŠ æ‹¦æˆªè§„åˆ™</div>
        <div class="modal-body">
          <div class="form-group">
            <label for="rule-name">è§„åˆ™åç§°</label>
            <input type="text" id="rule-name" placeholder="ä¾‹å¦‚ï¼šä¿å­˜ç™¾åº¦è¯·æ±‚" />
          </div>

          <div class="form-group">
            <label for="rule-type">è§„åˆ™ç±»å‹</label>
            <select id="rule-type">
              <option value="Request">è¯·æ±‚</option>
              <option value="Response">å“åº”</option>
              <option value="Both">è¯·æ±‚å’Œå“åº”</option>
            </select>
          </div>

          <div class="form-group">
            <label for="rule-url-pattern">URL åŒ¹é…æ¨¡å¼ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼Œå¯é€‰ï¼‰</label>
            <input type="text" id="rule-url-pattern" placeholder="ä¾‹å¦‚ï¼š.*baidu.com.*" />
          </div>

          <div class="form-group">
            <label for="rule-method">HTTP æ–¹æ³•ï¼ˆå¯é€‰ï¼‰</label>
            <select id="rule-method">
              <option value="">ä»»æ„</option>
              <option value="GET">GET</option>
              <option value="POST">POST</option>
              <option value="PUT">PUT</option>
              <option value="DELETE">DELETE</option>
            </select>
          </div>

          <div class="form-group">
            <label for="rule-action-type">æ“ä½œç±»å‹</label>
            <select id="rule-action-type">
              <option value="SaveData">ä¿å­˜æ•°æ®</option>
              <option value="ModifyHeaders">ä¿®æ”¹å¤´éƒ¨</option>
              <option value="MockResponse">è¿”å›Mockå“åº”</option>
              <option value="Block">é˜»æ­¢è¯·æ±‚</option>
            </select>
          </div>

          <!-- SaveData æ“ä½œå‚æ•° -->
          <div id="action-savedata" class="action-params">
            <div class="form-group">
              <label>ä¿å­˜é€‰é¡¹</label>
              <label style="display: flex; align-items: center; gap: 10px; font-weight: normal;">
                <input type="checkbox" id="save-request" checked />
                ä¿å­˜è¯·æ±‚
              </label>
              <label style="display: flex; align-items: center; gap: 10px; font-weight: normal;">
                <input type="checkbox" id="save-response" checked />
                ä¿å­˜å“åº”
              </label>
            </div>
            <div class="form-group">
              <label for="save-file-path">ä¿å­˜æ–‡ä»¶è·¯å¾„</label>
              <input type="text" id="save-file-path" placeholder="/tmp/proxy-data.txt" />
            </div>
          </div>

          <!-- ModifyHeaders æ“ä½œå‚æ•° -->
          <div id="action-modifyheaders" class="action-params" style="display: none;">
            <div class="form-group">
              <label for="headers-add">æ·»åŠ å¤´éƒ¨ï¼ˆJSON æ ¼å¼ï¼‰</label>
              <textarea id="headers-add" rows="3" placeholder='[["X-Custom", "value"]]'></textarea>
            </div>
            <div class="form-group">
              <label for="headers-remove">åˆ é™¤å¤´éƒ¨ï¼ˆJSON æ•°ç»„ï¼‰</label>
              <textarea id="headers-remove" rows="2" placeholder='["User-Agent"]'></textarea>
            </div>
          </div>

          <!-- MockResponse æ“ä½œå‚æ•° -->
          <div id="action-mockresponse" class="action-params" style="display: none;">
            <div class="form-group">
              <label for="mock-status">HTTP çŠ¶æ€ç </label>
              <input type="number" id="mock-status" value="200" />
            </div>
            <div class="form-group">
              <label for="mock-body">å“åº”å†…å®¹</label>
              <textarea id="mock-body" rows="4" placeholder='{"message": "Mocked response"}'></textarea>
            </div>
          </div>

          <!-- Block æ“ä½œå‚æ•° -->
          <div id="action-block" class="action-params" style="display: none;">
            <div class="form-group">
              <label for="block-status">HTTP çŠ¶æ€ç </label>
              <input type="number" id="block-status" value="403" />
            </div>
            <div class="form-group">
              <label for="block-message">é˜»æ­¢æ¶ˆæ¯</label>
              <input type="text" id="block-message" value="Request blocked by proxy" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="rule-modal-cancel">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="rule-modal-save">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤è§„åˆ™å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="delete-rule-modal">
      <div class="modal-content">
        <div class="modal-header">âš ï¸ ç¡®è®¤åˆ é™¤è§„åˆ™</div>
        <div class="modal-body">
          æ‚¨ç¡®å®šè¦åˆ é™¤æ­¤æ‹¦æˆªè§„åˆ™å—ï¼Ÿ<br /><br />
          æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="delete-rule-cancel">å–æ¶ˆ</button>
          <button class="btn btn-danger" id="delete-rule-confirm">ç¡®å®šåˆ é™¤</button>
        </div>
      </div>
    </div>

    <script type="module">
      // Tauri API
      let invoke = null
      let listen = null

      async function initTauri() {
        if (window.__TAURI__?.core?.invoke) {
          invoke = window.__TAURI__.core.invoke
        }
        if (window.__TAURI__?.event?.listen) {
          listen = window.__TAURI__.event.listen
        }

        if (!invoke || !listen) {
          showMessage('system-status', 'Tauri API æœªåŠ è½½', 'error')
          return false
        }
        return true
      }

      // Utility functions
      function showMessage(containerId, message, type = 'info') {
        const container = document.getElementById(containerId)
        if (container) {
          container.innerText = message // Use innerText to preserve line breaks
          container.className = `message ${type}`
          container.style.display = 'block'

          // Don't auto-hide error messages (they often contain important instructions)
          // Success and info messages auto-hide after 10 seconds
          if (type !== 'error') {
            setTimeout(() => {
              container.style.display = 'none'
            }, 10000)
          }
        }
      }

      // Tab switching
      document.querySelectorAll('.tab').forEach((tab) => {
        tab.addEventListener('click', () => {
          document
            .querySelectorAll('.tab')
            .forEach((t) => t.classList.remove('active'))
          document
            .querySelectorAll('.tab-content')
            .forEach((c) => c.classList.remove('active'))

          tab.classList.add('active')
          document
            .getElementById(`tab-${tab.dataset.tab}`)
            .classList.add('active')
        })
      })

      // Server controls
      async function updateServerStatus() {
        if (!invoke) return
        try {
          const running = await invoke('is_proxy_server_running')
          const badge = document.getElementById('status-badge')
          const startBtn = document.getElementById('start-server')
          const stopBtn = document.getElementById('stop-server')

          if (running) {
            badge.textContent = 'â— è¿è¡Œä¸­'
            badge.className = 'status-indicator status-running'
            startBtn.disabled = true
            stopBtn.disabled = false
          } else {
            badge.textContent = 'â— æœªè¿è¡Œ'
            badge.className = 'status-indicator status-stopped'
            startBtn.disabled = false
            stopBtn.disabled = true
          }
        } catch (e) {
          console.error('Failed to check server status:', e)
        }
      }

      document
        .getElementById('start-server')
        .addEventListener('click', async () => {
          const port = parseInt(document.getElementById('proxy-port').value)
          const enableHttps = document.getElementById('enable-https').checked

          try {
            const result = await invoke('start_proxy_server', {
              port,
              enableHttpsIntercept: enableHttps,
            })
            showMessage('server-status', result, 'success')
            await updateServerStatus()
          } catch (e) {
            showMessage('server-status', String(e), 'error')
          }
        })

      document
        .getElementById('stop-server')
        .addEventListener('click', async () => {
          try {
            const result = await invoke('stop_proxy_server')
            showMessage('server-status', result, 'success')
            await updateServerStatus()
          } catch (e) {
            showMessage('server-status', String(e), 'error')
          }
        })

      // System proxy controls
      document.getElementById('apply').addEventListener('click', async () => {
        const host = document.getElementById('host').value.trim()
        const port = parseInt(document.getElementById('port').value)

        try {
          await invoke('set_system_proxy', { host, port })
          showMessage(
            'system-status',
            `å·²è®¾ç½®ç³»ç»Ÿä»£ç†ä¸º ${host}:${port}`,
            'success'
          )
          refreshSaved()
          refreshCurrent()
        } catch (e) {
          showMessage('system-status', String(e), 'error')
        }
      })

      document.getElementById('restore').addEventListener('click', async () => {
        try {
          await invoke('restore_system_proxy')
          showMessage('system-status', 'å·²æ¢å¤åŸä»£ç†é…ç½®', 'success')
          refreshSaved()
          refreshCurrent()
        } catch (e) {
          showMessage('system-status', String(e), 'error')
        }
      })

      document
        .getElementById('current')
        .addEventListener('click', refreshCurrent)

      async function refreshSaved() {
        try {
          const data = await invoke('get_saved_proxy')
          document.getElementById('saved').value = data
            ? JSON.stringify(data, null, 2)
            : ''
        } catch (e) {
          console.error('Failed to get saved proxy:', e)
        }
      }

      async function refreshCurrent() {
        try {
          const data = await invoke('get_current_proxy')
          document.getElementById('current-text').value = JSON.stringify(
            data,
            null,
            2
          )
        } catch (e) {
          showMessage('system-status', String(e), 'error')
        }
      }

      // Certificate management
      async function updateCertStatus() {
        try {
          const [installed, path] = await Promise.all([
            invoke('is_certificate_installed'),
            invoke('get_ca_cert_path'),
          ])

          document.getElementById('cert-installed').textContent = installed
            ? 'âœ… å·²å®‰è£…'
            : 'âŒ æœªå®‰è£…'
          document.getElementById('cert-path').textContent = path
        } catch (e) {
          document.getElementById('cert-installed').textContent = 'æ£€æŸ¥å¤±è´¥'
          document.getElementById('cert-path').textContent = 'N/A'
        }
      }

      document
        .getElementById('install-cert')
        .addEventListener('click', async () => {
          try {
            const result = await invoke('install_ca_certificate')
            showMessage('cert-status', result, 'success')
            await updateCertStatus()
          } catch (e) {
            showMessage('cert-status', String(e), 'error')
          }
        })

      document
        .getElementById('uninstall-cert')
        .addEventListener('click', async () => {
          // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
          showConfirmModal()
        })

      // ç¡®è®¤å¯¹è¯æ¡†é€»è¾‘
      function showConfirmModal() {
        const modal = document.getElementById('confirm-modal')
        modal.classList.add('active')
      }

      function hideConfirmModal() {
        const modal = document.getElementById('confirm-modal')
        modal.classList.remove('active')
      }

      document.getElementById('modal-cancel').addEventListener('click', () => {
        hideConfirmModal()
      })

      document
        .getElementById('modal-confirm')
        .addEventListener('click', async () => {
          hideConfirmModal()

          try {
            const result = await invoke('uninstall_ca_certificate')
            showMessage('cert-status', result, 'success')
            await updateCertStatus()
          } catch (e) {
            showMessage('cert-status', String(e), 'error')
          }
        })

      // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
      document
        .getElementById('confirm-modal')
        .addEventListener('click', (e) => {
          if (e.target.id === 'confirm-modal') {
            hideConfirmModal()
          }
        })

      document
        .getElementById('check-cert')
        .addEventListener('click', updateCertStatus)

      document
        .getElementById('open-cert-folder')
        .addEventListener('click', async () => {
          try {
            const result = await invoke('open_cert_folder')
            showMessage('cert-status', result, 'success')
          } catch (e) {
            showMessage('cert-status', String(e), 'error')
          }
        })

      // Rules management
      let currentEditingRuleId = null
      let ruleIdToDelete = null
      const rulesContainer = document.getElementById('rules-container')

      // Load and display rules
      async function loadRules() {
        try {
          const rules = await invoke('get_intercept_rules')
          displayRules(rules)
        } catch (e) {
          showMessage('rules-status', String(e), 'error')
        }
      }

      // Display rules in the container
      function displayRules(rules) {
        if (rules.length === 0) {
          rulesContainer.innerHTML =
            '<p style="color: #6b7280">æš‚æ— è§„åˆ™ã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ è§„åˆ™ã€‚</p>'
          return
        }

        rulesContainer.innerHTML = rules
          .map(
            (rule) => `
          <div class="rule-item">
            <div class="rule-header">
              <div>
                <span class="rule-name">${rule.name}</span>
                <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">${rule.rule_type}</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <label class="switch">
                  <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleRule('${rule.id}', this.checked)">
                  <span class="slider"></span>
                </label>
                <button class="btn btn-sm btn-secondary" onclick="editRule('${rule.id}')">ç¼–è¾‘</button>
                <button class="btn btn-sm btn-danger" onclick="deleteRule('${rule.id}')">åˆ é™¤</button>
              </div>
            </div>
            <div class="rule-details">
              ${rule.match_pattern.url_pattern ? `URL: ${rule.match_pattern.url_pattern}` : ''}
              ${rule.match_pattern.method ? ` | æ–¹æ³•: ${rule.match_pattern.method}` : ''}
            </div>
          </div>
        `
          )
          .join('')
      }

      // Show rule modal for adding new rule
      document.getElementById('add-rule-btn').addEventListener('click', () => {
        currentEditingRuleId = null
        document.getElementById('rule-modal-title').textContent = 'æ·»åŠ æ‹¦æˆªè§„åˆ™'
        clearRuleForm()
        showRuleModal()
      })

      // Show/hide rule modal
      function showRuleModal() {
        document.getElementById('rule-modal').classList.add('active')
      }

      function hideRuleModal() {
        document.getElementById('rule-modal').classList.remove('active')
      }

      // Clear rule form
      function clearRuleForm() {
        document.getElementById('rule-name').value = ''
        document.getElementById('rule-type').value = 'Request'
        document.getElementById('rule-url-pattern').value = ''
        document.getElementById('rule-method').value = ''
        document.getElementById('rule-action-type').value = 'SaveData'
        document.getElementById('save-request').checked = true
        document.getElementById('save-response').checked = true
        document.getElementById('save-file-path').value = '/tmp/proxy-data.txt'
        updateActionParams()
      }

      // Update action params visibility based on action type
      function updateActionParams() {
        const actionType = document.getElementById('rule-action-type').value
        document.querySelectorAll('.action-params').forEach((el) => {
          el.style.display = 'none'
        })
        const selectedParam = document.getElementById(`action-${actionType.toLowerCase()}`)
        if (selectedParam) {
          selectedParam.style.display = 'block'
        }
      }

      document
        .getElementById('rule-action-type')
        .addEventListener('change', updateActionParams)

      // Save rule
      document.getElementById('rule-modal-save').addEventListener('click', async () => {
        try {
          const rule = buildRuleFromForm()

          if (currentEditingRuleId) {
            await invoke('update_intercept_rule', { rule })
            showMessage('rules-status', 'è§„åˆ™å·²æ›´æ–°', 'success')
          } else {
            await invoke('add_intercept_rule', { rule })
            showMessage('rules-status', 'è§„åˆ™å·²æ·»åŠ ', 'success')
          }

          hideRuleModal()
          loadRules()
        } catch (e) {
          showMessage('rules-status', String(e), 'error')
        }
      })

      // Build rule object from form
      function buildRuleFromForm() {
        const actionType = document.getElementById('rule-action-type').value
        let action

        switch (actionType) {
          case 'SaveData':
            action = {
              SaveData: {
                save_request: document.getElementById('save-request').checked,
                save_response: document.getElementById('save-response').checked,
                file_path: document.getElementById('save-file-path').value,
              },
            }
            break
          case 'ModifyHeaders':
            action = {
              ModifyHeaders: {
                add: JSON.parse(document.getElementById('headers-add').value || '[]'),
                remove: JSON.parse(document.getElementById('headers-remove').value || '[]'),
              },
            }
            break
          case 'MockResponse':
            action = {
              MockResponse: {
                status: parseInt(document.getElementById('mock-status').value),
                headers: [],
                body: document.getElementById('mock-body').value,
              },
            }
            break
          case 'Block':
            action = {
              Block: {
                status: parseInt(document.getElementById('block-status').value),
                message: document.getElementById('block-message').value,
              },
            }
            break
        }

        return {
          id: currentEditingRuleId || Date.now().toString(),
          enabled: true,
          name: document.getElementById('rule-name').value,
          rule_type: document.getElementById('rule-type').value,
          match_pattern: {
            url_pattern: document.getElementById('rule-url-pattern').value || null,
            method: document.getElementById('rule-method').value || null,
            content_type: null,
          },
          action,
        }
      }

      // Global functions for rule actions
      window.toggleRule = async function (ruleId, enabled) {
        try {
          const rules = await invoke('get_intercept_rules')
          const rule = rules.find((r) => r.id === ruleId)
          if (rule) {
            rule.enabled = enabled
            await invoke('update_intercept_rule', { rule })
          }
        } catch (e) {
          showMessage('rules-status', String(e), 'error')
          loadRules() // Reload to reset checkbox
        }
      }

      window.editRule = async function (ruleId) {
        try {
          const rules = await invoke('get_intercept_rules')
          const rule = rules.find((r) => r.id === ruleId)
          if (rule) {
            currentEditingRuleId = ruleId
            document.getElementById('rule-modal-title').textContent = 'ç¼–è¾‘æ‹¦æˆªè§„åˆ™'
            fillRuleForm(rule)
            showRuleModal()
          }
        } catch (e) {
          showMessage('rules-status', String(e), 'error')
        }
      }

      window.deleteRule = function (ruleId) {
        ruleIdToDelete = ruleId
        showDeleteRuleModal()
      }

      // Fill form with rule data for editing
      function fillRuleForm(rule) {
        document.getElementById('rule-name').value = rule.name
        document.getElementById('rule-type').value = rule.rule_type
        document.getElementById('rule-url-pattern').value = rule.match_pattern.url_pattern || ''
        document.getElementById('rule-method').value = rule.match_pattern.method || ''

        // Fill action params based on action type
        const actionKey = Object.keys(rule.action)[0]
        document.getElementById('rule-action-type').value = actionKey
        updateActionParams()

        const actionData = rule.action[actionKey]
        switch (actionKey) {
          case 'SaveData':
            document.getElementById('save-request').checked = actionData.save_request
            document.getElementById('save-response').checked = actionData.save_response
            document.getElementById('save-file-path').value = actionData.file_path
            break
          case 'ModifyHeaders':
            document.getElementById('headers-add').value = JSON.stringify(actionData.add, null, 2)
            document.getElementById('headers-remove').value = JSON.stringify(actionData.remove, null, 2)
            break
          case 'MockResponse':
            document.getElementById('mock-status').value = actionData.status
            document.getElementById('mock-body').value = actionData.body
            break
          case 'Block':
            document.getElementById('block-status').value = actionData.status
            document.getElementById('block-message').value = actionData.message
            break
        }
      }

      // Rule modal controls
      document.getElementById('rule-modal-cancel').addEventListener('click', hideRuleModal)
      document.getElementById('rule-modal').addEventListener('click', (e) => {
        if (e.target.id === 'rule-modal') {
          hideRuleModal()
        }
      })

      // Delete rule modal controls
      function showDeleteRuleModal() {
        document.getElementById('delete-rule-modal').classList.add('active')
      }

      function hideDeleteRuleModal() {
        document.getElementById('delete-rule-modal').classList.remove('active')
      }

      document.getElementById('delete-rule-cancel').addEventListener('click', () => {
        hideDeleteRuleModal()
      })

      document.getElementById('delete-rule-confirm').addEventListener('click', async () => {
        hideDeleteRuleModal()

        if (ruleIdToDelete) {
          try {
            await invoke('remove_intercept_rule', { ruleId: ruleIdToDelete })
            showMessage('rules-status', 'è§„åˆ™å·²åˆ é™¤', 'success')
            loadRules()
          } catch (e) {
            showMessage('rules-status', String(e), 'error')
          }
          ruleIdToDelete = null
        }
      })

      // Click outside modal to close
      document.getElementById('delete-rule-modal').addEventListener('click', (e) => {
        if (e.target.id === 'delete-rule-modal') {
          hideDeleteRuleModal()
        }
      })


      // Process filtering
      let allProcesses = []
      let selectedProcesses = new Set()
      let processIcons = new Map() // Cache for process icons: name -> base64 data URL

      // Get process icon (async, tries to extract real icon first, falls back to emoji)
      async function getProcessIcon(name, exePath) {
        // Check cache first
        if (processIcons.has(name)) {
          return processIcons.get(name)
        }

        // Try to extract real app icon
        try {
          const iconData = await invoke('get_app_icon', { exePath })
          if (iconData) {
            processIcons.set(name, iconData)
            return iconData
          }
        } catch (e) {
          console.log('Failed to extract icon for', name, e)
        }

        // Fallback to emoji icons
        const icon = getEmojiIcon(name)
        processIcons.set(name, icon)
        return icon
      }

      // SVG icon cache: iconName -> data URL
      const svgIconCache = new Map()

      // Load SVG icon from file and convert to data URL
      async function loadSvgIcon(iconName) {
        // Check cache first
        if (svgIconCache.has(iconName)) {
          return svgIconCache.get(iconName)
        }

        try {
          const response = await fetch(`/icons/${iconName}.svg`)
          const svgText = await response.text()
          const dataUrl = 'data:image/svg+xml;base64,' + btoa(svgText)
          svgIconCache.set(iconName, dataUrl)
          return dataUrl
        } catch (e) {
          console.error(`Failed to load SVG icon: ${iconName}`, e)
          // Fallback to a simple placeholder
          return 'data:image/svg+xml;base64,' + btoa(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
            </svg>
          `)
        }
      }

      // Get SVG icon as fallback (async)
      async function getEmojiIcon(name) {
        // Helper/Renderer processes - gear icon
        if (name.toLowerCase().includes('helper') || name.toLowerCase().includes('renderer')) {
          return await loadSvgIcon('gear')
        }

        // Default app icon - terminal icon
        return await loadSvgIcon('terminal')
      }

      // Load processes list
      async function loadProcesses() {
        try {
          const processes = await invoke('get_system_processes_with_info')
          allProcesses = processes
          displayProcesses(processes)
        } catch (e) {
          showMessage('process-status', String(e), 'error')
        }
      }

      // Display processes in list
      async function displayProcesses(processes) {
        const container = document.getElementById('process-list-container')

        // Group by process name and collect info
        const processMap = new Map()
        processes.forEach(({pid, name, exe_path}) => {
          if (!processMap.has(name)) {
            processMap.set(name, {
              pids: [],
              exePath: exe_path
            })
          }
          processMap.get(name).pids.push(pid)
        })

        // Sort by name
        const sortedProcesses = Array.from(processMap.entries()).sort((a, b) => a[0].localeCompare(b[0]))

        // First render with placeholders
        container.innerHTML = sortedProcesses
          .map(([name, {pids, exePath}]) => `
            <div style="padding: 8px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 8px;"
                 onclick="toggleProcessSelection('${name.replace(/'/g, "\\'")}')"
                 data-process-name="${name}">
              <input type="checkbox" ${selectedProcesses.has(name) ? 'checked' : ''}
                     onchange="toggleProcessSelection('${name.replace(/'/g, "\\'")}')"
                     onclick="event.stopPropagation()">
              <span class="process-icon-${name.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-size: 20px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">â³</span>
              <div style="flex: 1;">
                <div>
                  <strong>${name}</strong>
                  <span style="color: #6b7280; font-size: 11px; margin-left: 8px;">(${pids.length} ä¸ªå®ä¾‹)</span>
                </div>
                <div style="color: #6b7280; font-size: 11px; margin-top: 2px; word-break: break-all;">${exePath}</div>
              </div>
            </div>
          `)
          .join('')

        // Load icons asynchronously
        for (const [name, {exePath}] of sortedProcesses) {
          const iconClass = `process-icon-${name.replace(/[^a-zA-Z0-9]/g, '_')}`
          const icon = await getProcessIcon(name, exePath)

          // Update icon in DOM
          const iconElement = document.querySelector(`.${iconClass}`)
          if (iconElement) {
            if (icon.startsWith('data:image/')) {
              // Real icon (base64 image)
              iconElement.innerHTML = `<img src="${icon}" style="width: 24px; height: 24px; object-fit: contain;" alt="${name}">`
            } else {
              // Emoji icon
              iconElement.textContent = icon
            }
          }
        }
      }

      // Toggle process selection
      window.toggleProcessSelection = function(processName) {
        if (selectedProcesses.has(processName)) {
          selectedProcesses.delete(processName)
        } else {
          selectedProcesses.add(processName)
        }

        // Update checkbox state
        const checkbox = document.querySelector(`[data-process-name="${processName}"] input`)
        if (checkbox) {
          checkbox.checked = selectedProcesses.has(processName)
        }

        updateSelectedProcessesDisplay()
        applyProcessFilter()
      }

      // Update selected processes display
      function updateSelectedProcessesDisplay() {
        const container = document.getElementById('selected-processes')
        if (selectedProcesses.size === 0) {
          container.innerHTML = '<span style="color: #6b7280;">æš‚æ— é€‰æ‹©</span>'
        } else {
          container.innerHTML = Array.from(selectedProcesses)
            .map(name => `
              <span style="display: inline-block; padding: 4px 8px; margin: 4px; background: var(--bg-secondary); border-radius: 4px; font-size: 13px;">
                ${name}
                <button onclick="removeProcessSelection('${name}')" style="border: none; background: none; cursor: pointer; margin-left: 4px; color: var(--danger);">âœ•</button>
              </span>
            `)
            .join('')
        }
      }

      // Remove process from selection
      window.removeProcessSelection = function(processName) {
        selectedProcesses.delete(processName)
        displayProcesses(allProcesses.filter(({name}) => {
          const searchTerm = document.getElementById('process-search').value.toLowerCase()
          return searchTerm === '' || name.toLowerCase().includes(searchTerm)
        }))
        updateSelectedProcessesDisplay()
        applyProcessFilter()
      }

      // Apply process filter
      async function applyProcessFilter() {
        try {
          const enabled = document.getElementById('enable-process-filter').checked
          const blacklistMode = document.getElementById('blacklist-mode').checked

          await invoke('set_process_filter', {
            filter: {
              enabled,
              allowed_processes: Array.from(selectedProcesses),
              blacklist_mode: blacklistMode
            }
          })
        } catch (e) {
          showMessage('process-status', String(e), 'error')
        }
      }

      // Search processes
      document.getElementById('process-search').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase()
        const filtered = allProcesses.filter(({name}) =>
          name.toLowerCase().includes(searchTerm)
        )
        displayProcesses(filtered)
      })

      // Refresh processes button
      document.getElementById('refresh-processes').addEventListener('click', loadProcesses)

      // Clear process filter button
      document.getElementById('clear-process-filter').addEventListener('click', () => {
        selectedProcesses.clear()
        displayProcesses(allProcesses)
        updateSelectedProcessesDisplay()
        applyProcessFilter()
      })

      // Enable/disable process filter
      document.getElementById('enable-process-filter').addEventListener('change', applyProcessFilter)

      // Blacklist mode toggle
      document.getElementById('blacklist-mode').addEventListener('change', applyProcessFilter)

      // TUN Proxy controls
      async function updateTunStatus() {
        if (!invoke) return

        try {
          const statusJson = await invoke('get_tun_status')
          const status = JSON.parse(statusJson)
          const badge = document.getElementById('tun-status-badge')
          const infoDiv = document.getElementById('tun-info')
          const startBtn = document.getElementById('start-tun')
          const stopBtn = document.getElementById('stop-tun')

          infoDiv.style.display = 'block'
          document.getElementById('tun-version').textContent = status.version

          // æ ¹æ®å¹³å°æ˜¾ç¤º TUN è®¾å¤‡å
          let deviceName = '-'
          if (window.navigator.platform.includes('Mac')) {
            deviceName = 'utun123'
          } else if (window.navigator.platform.includes('Win')) {
            deviceName = 'SysproxyTun'
          } else if (window.navigator.platform.includes('Linux')) {
            deviceName = 'sysproxy0'
          }
          document.getElementById('tun-device').textContent = deviceName

          if (status.running && status.tun_enabled) {
            badge.textContent = 'â— è¿è¡Œä¸­'
            badge.className = 'status-indicator status-running'
            startBtn.disabled = true
            stopBtn.disabled = false
          } else {
            badge.textContent = 'â— æœªè¿è¡Œ'
            badge.className = 'status-indicator status-stopped'
            startBtn.disabled = false
            stopBtn.disabled = true
          }
        } catch (e) {
          console.error('Failed to check TUN status:', e)
          // TUN æœªè¿è¡Œæ—¶çš„é”™è¯¯æ˜¯æ­£å¸¸çš„
          const badge = document.getElementById('tun-status-badge')
          badge.textContent = 'â— æœªè¿è¡Œ'
          badge.className = 'status-indicator status-stopped'

          const startBtn = document.getElementById('start-tun')
          const stopBtn = document.getElementById('stop-tun')
          startBtn.disabled = false
          stopBtn.disabled = true
        }
      }

      document.getElementById('start-tun').addEventListener('click', async () => {
        // æ£€æŸ¥ HTTP ä»£ç†æ˜¯å¦å·²å¯åŠ¨
        const httpRunning = await invoke('is_proxy_server_running')
        if (!httpRunning) {
          showMessage('tun-status', 'è¯·å…ˆå¯åŠ¨ HTTP ä»£ç†æœåŠ¡å™¨ï¼ˆåœ¨"ä»£ç†æœåŠ¡å™¨"æ ‡ç­¾é¡µï¼‰', 'error')
          return
        }

        try {
          const result = await invoke('start_tun_proxy')
          showMessage('tun-status', result, 'success')
          await updateTunStatus()
        } catch (e) {
          showMessage('tun-status', String(e), 'error')
        }
      })

      document.getElementById('stop-tun').addEventListener('click', async () => {
        try {
          const result = await invoke('stop_tun_proxy')
          showMessage('tun-status', result, 'success')
          await updateTunStatus()
        } catch (e) {
          showMessage('tun-status', String(e), 'error')
        }
      })

      // å½“è¿›ç¨‹è¿‡æ»¤é…ç½®å˜æ›´æ—¶ï¼ŒåŒæ­¥åˆ° TUN
      const originalApplyProcessFilter = applyProcessFilter
      applyProcessFilter = async function() {
        await originalApplyProcessFilter()

        // å¦‚æœ TUN æ­£åœ¨è¿è¡Œï¼ŒåŒæ­¥é…ç½®
        try {
          await invoke('update_tun_process_filter')
        } catch (e) {
          // é™é»˜å¤±è´¥ï¼ˆTUN æœªè¿è¡Œæ—¶ä¼šæŠ¥é”™ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰
          console.log('TUN process filter sync (ignored if TUN not running):', e)
        }
      }

      // Logs
      const logContainer = document.getElementById('log-container')
      const logs = []

      document.getElementById('clear-logs').addEventListener('click', () => {
        logs.length = 0
        logContainer.innerHTML = '<div style="color: #6b7280;">æ—¥å¿—å·²æ¸…ç©º</div>'
      })

      // Initialize
      ;(async () => {
        if (await initTauri()) {
          // ç›‘å¬ä»£ç†æ—¥å¿—äº‹ä»¶
          listen('proxy-log', (event) => {
            const log = event.payload
            logs.push(log)

            const entry = document.createElement('div')
            entry.className = 'log-entry'

            // æ„å»ºè¿›ç¨‹ä¿¡æ¯æ˜¾ç¤º
            const processInfo = log.process_name ? ` | Process: ${log.process_name}` : ''

            entry.innerHTML = `
              <div><strong>${log.timestamp}</strong> ${log.method} ${log.url}</div>
              <div style="color: #6b7280; font-size: 11px;">
                Status: ${log.status} | Request: ${log.request_size}B | Response: ${log.response_size}B${processInfo}
              </div>
            `

            if (logs.length === 1) {
              logContainer.innerHTML = ''
            }

            logContainer.appendChild(entry)
            logContainer.scrollTop = logContainer.scrollHeight

            if (logs.length > 100) {
              logs.shift()
              logContainer.removeChild(logContainer.firstChild)
            }
          })

          // ç›‘å¬ç³»ç»Ÿä»£ç†å˜æ›´äº‹ä»¶
          listen('proxy-changed', (event) => {
            console.log('Proxy changed:', event.payload)
            // æ›´æ–°å½“å‰ç³»ç»Ÿä»£ç†æ˜¾ç¤º
            const data = event.payload
            document.getElementById('current-text').value = JSON.stringify(
              data,
              null,
              2
            )
          })

          updateServerStatus()
          updateCertStatus()
          refreshSaved()
          refreshCurrent()
          loadRules()
          loadProcesses()
          updateTunStatus()
          setInterval(updateServerStatus, 2000)
          setInterval(updateTunStatus, 3000) // Check TUN status every 3 seconds
        }
      })()
    </script>
  </body>
</html>
