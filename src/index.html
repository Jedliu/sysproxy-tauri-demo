<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Sysproxy Demo - ä»£ç†æœåŠ¡å™¨</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
        color-scheme: light dark;
        --primary: #2563eb;
        --success: #16a34a;
        --danger: #dc2626;
        --warning: #f59e0b;
        --border: #e5e7eb;
        --bg-secondary: #f9fafb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      h1,
      h2,
      h3 {
        margin: 0 0 12px 0;
        font-weight: 600;
      }

      h1 {
        font-size: 24px;
      }
      h2 {
        font-size: 18px;
      }
      h3 {
        font-size: 16px;
      }

      .tabs {
        display: flex;
        gap: 8px;
        border-bottom: 2px solid var(--border);
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
      }

      .tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .card {
        padding: 20px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
      }

      .form-group {
        margin-bottom: 16px;
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 14px;
      }

      input[type='text'],
      input[type='number'],
      textarea,
      select {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid var(--border);
        font-family: inherit;
      }

      input[type='checkbox'] {
        width: auto;
        margin: 0;
        cursor: pointer;
      }

      textarea {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
        resize: vertical;
      }

      .btn {
        padding: 10px 16px;
        font-size: 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: opacity 0.2s;
      }

      .btn:hover:not(:disabled) {
        opacity: 0.9;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
      }
      .btn-secondary {
        background: #6b7280;
        color: white;
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
      }

      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-running {
        background: #dcfce7;
        color: var(--success);
      }
      .status-stopped {
        background: #fee2e2;
        color: var(--danger);
      }

      .log-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 10px;
        background: #f9fafb;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        font-size: 12px;
      }

      .log-entry {
        padding: 8px;
        margin-bottom: 4px;
        border-left: 3px solid var(--border);
        background: white;
      }

      .log-entry.success {
        border-left-color: var(--success);
      }
      .log-entry.error {
        border-left-color: var(--danger);
      }

      .rule-item {
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 10px;
        background: white;
      }

      .rule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .rule-name {
        font-weight: 600;
        font-size: 14px;
      }

      .rule-details {
        font-size: 12px;
        color: #6b7280;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: '';
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--success);
      }

      input:checked + .slider:before {
        transform: translateX(20px);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      .cert-info {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 13px;
        margin-top: 10px;
      }

      .message {
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 16px;
        font-size: 14px;
        white-space: pre-line; /* Preserve line breaks */
        line-height: 1.6;
      }

      .message.success {
        background: #dcfce7;
        color: var(--success);
      }
      .message.error {
        background: #fee2e2;
        color: var(--danger);
      }
      .message.info {
        background: #dbeafe;
        color: #2563eb;
      }

      /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 24px;
        border-radius: 8px;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .modal-header {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--danger);
      }

      .modal-body {
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
    </style>
  </head>
  <body>
    <h1>ğŸš€ Sysproxy ä»£ç†æœåŠ¡å™¨</h1>

    <div class="tabs">
      <button class="tab active" data-tab="server">ä»£ç†æœåŠ¡å™¨</button>
      <button class="tab" data-tab="system">ç³»ç»Ÿä»£ç†</button>
      <button class="tab" data-tab="certificate">è¯ä¹¦ç®¡ç†</button>
      <button class="tab" data-tab="rules">æ‹¦æˆªè§„åˆ™</button>
      <button class="tab" data-tab="logs">æ—¥å¿—æŸ¥çœ‹</button>
    </div>

    <!-- ä»£ç†æœåŠ¡å™¨ -->
    <div class="tab-content active" id="tab-server">
      <div class="card">
        <h2>ä»£ç†æœåŠ¡å™¨æ§åˆ¶</h2>
        <div
          id="server-status"
          class="message info"
          style="display: none"
        ></div>

        <div class="form-group">
          <label>
            æœåŠ¡å™¨çŠ¶æ€
            <span id="status-badge" class="status-indicator status-stopped"
              >â— æœªè¿è¡Œ</span
            >
          </label>
        </div>

        <div class="form-group">
          <label for="proxy-port">ç›‘å¬ç«¯å£</label>
          <input
            type="number"
            id="proxy-port"
            value="8888"
            min="1024"
            max="65535"
          />
        </div>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 10px">
            <input type="checkbox" id="enable-https" checked />
            å¯ç”¨ HTTPS æ‹¦æˆªï¼ˆMITMï¼‰
          </label>
        </div>

        <div class="btn-group">
          <button class="btn btn-success" id="start-server">
            å¯åŠ¨ä»£ç†æœåŠ¡å™¨
          </button>
          <button class="btn btn-danger" id="stop-server" disabled>
            åœæ­¢ä»£ç†æœåŠ¡å™¨
          </button>
        </div>
      </div>
    </div>

    <!-- ç³»ç»Ÿä»£ç† -->
    <div class="tab-content" id="tab-system">
      <div class="card">
        <h2>ç³»ç»Ÿä»£ç†è®¾ç½®</h2>
        <div id="system-status" class="message" style="display: none"></div>

        <div class="form-group">
          <label for="host">ä»£ç† IP</label>
          <input id="host" placeholder="ä¾‹å¦‚ 127.0.0.1" value="127.0.0.1" />
        </div>

        <div class="form-group">
          <label for="port">ä»£ç†ç«¯å£</label>
          <input id="port" type="number" placeholder="ä¾‹å¦‚ 8888" value="8888" />
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" id="apply">åº”ç”¨ä»£ç†</button>
          <button class="btn btn-secondary" id="restore">æ¢å¤åŸä»£ç†</button>
        </div>

        <div class="form-group" style="margin-top: 20px">
          <label>åŸä»£ç†é…ç½®ï¼ˆJSONï¼Œé¦–æ¬¡ä¿å­˜åæ˜¾ç¤ºï¼‰</label>
          <textarea id="saved" rows="8" readonly></textarea>
        </div>

        <div class="form-group">
          <label>
            å½“å‰ç³»ç»Ÿä»£ç†ï¼ˆJSONï¼‰
            <button
              class="btn btn-sm btn-secondary"
              id="current"
              style="margin-left: 10px"
            >
              åˆ·æ–°
            </button>
          </label>
          <textarea id="current-text" rows="8" readonly></textarea>
        </div>
      </div>
    </div>

    <!-- è¯ä¹¦ç®¡ç† -->
    <div class="tab-content" id="tab-certificate">
      <div class="card">
        <h2>HTTPS è¯ä¹¦ç®¡ç†</h2>
        <div id="cert-status" class="message" style="display: none"></div>

        <p>ä¸ºäº†æ‹¦æˆª HTTPS æµé‡ï¼Œéœ€è¦å®‰è£…è‡ªç­¾åçš„ CA è¯ä¹¦åˆ°ç³»ç»Ÿä¿¡ä»»å­˜å‚¨ã€‚</p>

        <div class="cert-info">
          <div>
            <strong>è¯ä¹¦çŠ¶æ€:</strong>
            <span id="cert-installed">æ£€æŸ¥ä¸­...</span>
          </div>
          <div>
            <strong>è¯ä¹¦è·¯å¾„:</strong> <span id="cert-path">åŠ è½½ä¸­...</span>
          </div>
        </div>

        <div class="btn-group" style="margin-top: 16px">
          <button class="btn btn-primary" id="install-cert">å®‰è£…è¯ä¹¦</button>
          <button class="btn btn-danger" id="uninstall-cert">åˆ é™¤è¯ä¹¦</button>
          <button class="btn btn-secondary" id="check-cert">
            æ£€æŸ¥è¯ä¹¦çŠ¶æ€
          </button>
          <button class="btn btn-secondary" id="open-cert-folder">
            æ‰“å¼€è¯ä¹¦æ–‡ä»¶å¤¹
          </button>
        </div>
      </div>
    </div>

    <!-- æ‹¦æˆªè§„åˆ™ -->
    <div class="tab-content" id="tab-rules">
      <div class="card">
        <h2>HTTP/HTTPS æ‹¦æˆªè§„åˆ™</h2>
        <div id="rules-status" class="message" style="display: none"></div>

        <button
          class="btn btn-primary"
          id="add-rule-btn"
          style="margin-bottom: 16px"
        >
          + æ·»åŠ æ–°è§„åˆ™
        </button>

        <div id="rules-container">
          <p style="color: #6b7280">æš‚æ— è§„åˆ™ã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ è§„åˆ™ã€‚</p>
        </div>
      </div>
    </div>

    <!-- æ—¥å¿—æŸ¥çœ‹ -->
    <div class="tab-content" id="tab-logs">
      <div class="card">
        <h2>
          ä»£ç†æ—¥å¿—
          <button
            class="btn btn-sm btn-secondary"
            id="clear-logs"
            style="margin-left: 10px"
          >
            æ¸…ç©ºæ—¥å¿—
          </button>
        </h2>

        <div class="log-container" id="log-container">
          <div style="color: #6b7280">ç­‰å¾…æ—¥å¿—...</div>
        </div>
      </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="confirm-modal">
      <div class="modal-content">
        <div class="modal-header">âš ï¸ ç¡®è®¤åˆ é™¤è¯ä¹¦</div>
        <div class="modal-body">
          æ‚¨ç¡®å®šè¦åˆ é™¤ Sysproxy MITM CA è¯ä¹¦å—ï¼Ÿ<br /><br />
          åˆ é™¤åå°†æ— æ³•æ‹¦æˆª HTTPS æµé‡ã€‚
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="modal-cancel">å–æ¶ˆ</button>
          <button class="btn btn-danger" id="modal-confirm">ç¡®å®šåˆ é™¤</button>
        </div>
      </div>
    </div>

    <script type="module">
      // Tauri API
      let invoke = null
      let listen = null

      async function initTauri() {
        if (window.__TAURI__?.core?.invoke) {
          invoke = window.__TAURI__.core.invoke
        }
        if (window.__TAURI__?.event?.listen) {
          listen = window.__TAURI__.event.listen
        }

        if (!invoke || !listen) {
          showMessage('system-status', 'Tauri API æœªåŠ è½½', 'error')
          return false
        }
        return true
      }

      // Utility functions
      function showMessage(containerId, message, type = 'info') {
        const container = document.getElementById(containerId)
        if (container) {
          container.innerText = message // Use innerText to preserve line breaks
          container.className = `message ${type}`
          container.style.display = 'block'

          // Don't auto-hide error messages (they often contain important instructions)
          // Success and info messages auto-hide after 10 seconds
          if (type !== 'error') {
            setTimeout(() => {
              container.style.display = 'none'
            }, 10000)
          }
        }
      }

      // Tab switching
      document.querySelectorAll('.tab').forEach((tab) => {
        tab.addEventListener('click', () => {
          document
            .querySelectorAll('.tab')
            .forEach((t) => t.classList.remove('active'))
          document
            .querySelectorAll('.tab-content')
            .forEach((c) => c.classList.remove('active'))

          tab.classList.add('active')
          document
            .getElementById(`tab-${tab.dataset.tab}`)
            .classList.add('active')
        })
      })

      // Server controls
      async function updateServerStatus() {
        if (!invoke) return
        try {
          const running = await invoke('is_proxy_server_running')
          const badge = document.getElementById('status-badge')
          const startBtn = document.getElementById('start-server')
          const stopBtn = document.getElementById('stop-server')

          if (running) {
            badge.textContent = 'â— è¿è¡Œä¸­'
            badge.className = 'status-indicator status-running'
            startBtn.disabled = true
            stopBtn.disabled = false
          } else {
            badge.textContent = 'â— æœªè¿è¡Œ'
            badge.className = 'status-indicator status-stopped'
            startBtn.disabled = false
            stopBtn.disabled = true
          }
        } catch (e) {
          console.error('Failed to check server status:', e)
        }
      }

      document
        .getElementById('start-server')
        .addEventListener('click', async () => {
          const port = parseInt(document.getElementById('proxy-port').value)
          const enableHttps = document.getElementById('enable-https').checked

          try {
            const result = await invoke('start_proxy_server', {
              port,
              enableHttpsIntercept: enableHttps,
            })
            showMessage('server-status', result, 'success')
            await updateServerStatus()
          } catch (e) {
            showMessage('server-status', String(e), 'error')
          }
        })

      document
        .getElementById('stop-server')
        .addEventListener('click', async () => {
          try {
            const result = await invoke('stop_proxy_server')
            showMessage('server-status', result, 'success')
            await updateServerStatus()
          } catch (e) {
            showMessage('server-status', String(e), 'error')
          }
        })

      // System proxy controls
      document.getElementById('apply').addEventListener('click', async () => {
        const host = document.getElementById('host').value.trim()
        const port = parseInt(document.getElementById('port').value)

        try {
          await invoke('set_system_proxy', { host, port })
          showMessage(
            'system-status',
            `å·²è®¾ç½®ç³»ç»Ÿä»£ç†ä¸º ${host}:${port}`,
            'success'
          )
          refreshSaved()
          refreshCurrent()
        } catch (e) {
          showMessage('system-status', String(e), 'error')
        }
      })

      document.getElementById('restore').addEventListener('click', async () => {
        try {
          await invoke('restore_system_proxy')
          showMessage('system-status', 'å·²æ¢å¤åŸä»£ç†é…ç½®', 'success')
          refreshSaved()
          refreshCurrent()
        } catch (e) {
          showMessage('system-status', String(e), 'error')
        }
      })

      document
        .getElementById('current')
        .addEventListener('click', refreshCurrent)

      async function refreshSaved() {
        try {
          const data = await invoke('get_saved_proxy')
          document.getElementById('saved').value = data
            ? JSON.stringify(data, null, 2)
            : ''
        } catch (e) {
          console.error('Failed to get saved proxy:', e)
        }
      }

      async function refreshCurrent() {
        try {
          const data = await invoke('get_current_proxy')
          document.getElementById('current-text').value = JSON.stringify(
            data,
            null,
            2
          )
        } catch (e) {
          showMessage('system-status', String(e), 'error')
        }
      }

      // Certificate management
      async function updateCertStatus() {
        try {
          const [installed, path] = await Promise.all([
            invoke('is_certificate_installed'),
            invoke('get_ca_cert_path'),
          ])

          document.getElementById('cert-installed').textContent = installed
            ? 'âœ… å·²å®‰è£…'
            : 'âŒ æœªå®‰è£…'
          document.getElementById('cert-path').textContent = path
        } catch (e) {
          document.getElementById('cert-installed').textContent = 'æ£€æŸ¥å¤±è´¥'
          document.getElementById('cert-path').textContent = 'N/A'
        }
      }

      document
        .getElementById('install-cert')
        .addEventListener('click', async () => {
          try {
            const result = await invoke('install_ca_certificate')
            showMessage('cert-status', result, 'success')
            await updateCertStatus()
          } catch (e) {
            showMessage('cert-status', String(e), 'error')
          }
        })

      document
        .getElementById('uninstall-cert')
        .addEventListener('click', async () => {
          // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
          showConfirmModal()
        })

      // ç¡®è®¤å¯¹è¯æ¡†é€»è¾‘
      function showConfirmModal() {
        const modal = document.getElementById('confirm-modal')
        modal.classList.add('active')
      }

      function hideConfirmModal() {
        const modal = document.getElementById('confirm-modal')
        modal.classList.remove('active')
      }

      document.getElementById('modal-cancel').addEventListener('click', () => {
        hideConfirmModal()
      })

      document
        .getElementById('modal-confirm')
        .addEventListener('click', async () => {
          hideConfirmModal()

          try {
            const result = await invoke('uninstall_ca_certificate')
            showMessage('cert-status', result, 'success')
            await updateCertStatus()
          } catch (e) {
            showMessage('cert-status', String(e), 'error')
          }
        })

      // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
      document
        .getElementById('confirm-modal')
        .addEventListener('click', (e) => {
          if (e.target.id === 'confirm-modal') {
            hideConfirmModal()
          }
        })

      document
        .getElementById('check-cert')
        .addEventListener('click', updateCertStatus)

      document
        .getElementById('open-cert-folder')
        .addEventListener('click', async () => {
          try {
            const result = await invoke('open_cert_folder')
            showMessage('cert-status', result, 'success')
          } catch (e) {
            showMessage('cert-status', String(e), 'error')
          }
        })

      // Rules management (simplified)
      document.getElementById('add-rule-btn').addEventListener('click', () => {
        showMessage('rules-status', 'è§„åˆ™ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...', 'info')
      })

      // Logs
      const logContainer = document.getElementById('log-container')
      const logs = []

      if (listen) {
        listen('proxy-log', (event) => {
          const log = event.payload
          logs.push(log)

          const entry = document.createElement('div')
          entry.className = 'log-entry'
          entry.innerHTML = `
            <div><strong>${log.timestamp}</strong> ${log.method} ${log.url}</div>
            <div style="color: #6b7280; font-size: 11px;">
              Status: ${log.status} | Request: ${log.request_size}B | Response: ${log.response_size}B
            </div>
          `

          if (logs.length === 1) {
            logContainer.innerHTML = ''
          }

          logContainer.appendChild(entry)
          logContainer.scrollTop = logContainer.scrollHeight

          if (logs.length > 100) {
            logs.shift()
            logContainer.removeChild(logContainer.firstChild)
          }
        })
      }

      document.getElementById('clear-logs').addEventListener('click', () => {
        logs.length = 0
        logContainer.innerHTML = '<div style="color: #6b7280;">æ—¥å¿—å·²æ¸…ç©º</div>'
      })

      // Initialize
      ;(async () => {
        if (await initTauri()) {
          updateServerStatus()
          updateCertStatus()
          refreshSaved()
          refreshCurrent()
          setInterval(updateServerStatus, 2000)
        }
      })()
    </script>
  </body>
</html>
